-- ==
-- tags { autodiff }
--  entry: rev_map rev_vec
--  input {
--    [4i64,5i64,2i64,4i64,5i64,2i64,0i64,0i64,4i64,5i64,1i64,4i64,1i64,3i64,3i64,1i64,8i64,-1i64]
--    [11f32,16f32,7f32,0f32,14f32,6f32,2f32,1f32,13f32,0f32,5f32,0f32,3f32,0f32,9f32,4f32,17f32,18f32]
--    [1f32,2f32,3f32,4f32,5f32,6f32,7f32,8f32]
--  }
--  output {
-- [[0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 2f32, 4f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 96f32, 0f32, 160f32, 0f32, 0f32, 120f32, 0f32, 0f32],
--  [0f32, 0f32, 36f32, 0f32, 0f32, 42f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 72f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 5376f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32]]
-- [[4f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 240f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 84f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0.5, 0f32],
--  [0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0f32, 0.5]]
-- }

def f [n] [m] (is: [n]i64) (vs: [n]f32, c: [m]f32) =
  let r = hist (\x y -> x * y * 2) 0.5 m is vs
  in map2 (*) r c

entry rev_map [n] [m] (is: [n]i64) (vs: [n]f32) (c: [m]f32) =
  tabulate m (\i -> vjp (f is) (vs, c) (replicate m 0 with [i] = 1))
  |> unzip

entry rev_vec [n] [m] (is: [n]i64) (vs: [n]f32) (c: [m]f32) =
  let seeds = tabulate m (\i -> replicate m 0 with [i] = 1)
  in vjp_vec (f is) (vs, c) seeds
     |> unzip
